String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^\s+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")},String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")});var GATReplay=fabric.util.createClass(fabric.Group,{type:"Replay",initialize:function(t,e,a){a||(a={width:canvas.width,height:canvas.height}),this.callSuper("initialize",[],a),t=t||[],this.commands=e||[],this.players={};for(var i in t){var n=this._playerComponent(t[i]);this.players[t[i]]=n,this.addWithUpdate(n)}this._timeBetweenCommands=1e3,this._currentCommand=0,this._execution=null},getPlayers:function(){return Object.keys(this.players)},_playerComponent:function(t){var e=Object.keys(this.players).length,a={fontFamily:"Comic Sans",fontSize:20,fontStyle:"italic",fill:"#fff",textShadow:"rgba(0,0,0,0.3) 1px 1px 1px",padding:10},i=new fabric.Text(t,a),n=0,r=0;switch(e){case 0:n=-200;var s=new fabric.Group([],{top:-200});break;case 1:n=-200;var s=new fabric.Group([],{top:200});break;case 2:r=-200;var s=new fabric.Group([],{left:-200});break;case 3:r=-200;var s=new fabric.Group([],{left:200});break;default:var s=new fabric.Group([],{})}return i.left=n,i.top=r,s.add(i),s},_nextCommand:function(){return void 0!=this.commands&&null!=this.commands&&this._currentCommand<this.commands.length?this.commands[this._currentCommand]:null},play:function(){function t(){var a=e._nextCommand();null!=a?(e._applyCommand(a),e._currentCommand+=1,e._execution=setTimeout(t,e._timeBetweenCommands)):(e.pause(),e.stop())}if(null==this._execution){var e=this;this._execution=setTimeout(t,this._timeBetweenCommands)}},pause:function(){null!=this._execution&&(clearTimeout(this._execution),this._execution=null)},stop:function(){this.pause(),this._currentCommand=0,canvas.clear()},increaseSpeed:function(){this._timeBetweenCommands=Math.max(this._timeBetweenCommands-100,100)},decreaseSpeed:function(){this._timeBetweenCommands=Math.min(this._timeBetweenCommands+100,3e3)},_applyCommand:function(t){args="",t.args&&(args=JSON.stringify(t.args));var e="";switch(t.player&&(e=t.player+": "),console.debug(e+t.name+"("+args+")"),t.name){case"StartGame":this._startGame(t);break;case"StartRound":this._startRound(t);break;case"EndRound":this._endRound(t);break;case"EndGame":this._endGame(t);break;default:if("Replay"===this.type){var e=this.players[t.player];e&&this._addPlayerMessage(t.name,e.left,e.top)}this._applyCustomCommand(t)}},_applyCustomCommand:function(){},_startGame:function(){this._addGameMessage(this.type)},_startRound:function(){this._addGameMessage("new round")},_endRound:function(){},_endGame:function(t){this._addGameMessage(t.summary)},_addGameMessage:function(t){var e={fontFamily:"Comic Sans",fontSize:50,fontWeight:"bold",fill:"#fff",stroke:"#fff",strokeWidth:2,opacity:0,textShadow:"rgba(0,0,0,0.3) 5px 5px 5px"};this._addTempMessage(t,e)},_addPlayerMessage:function(t,e,a){var i={left:e,top:a,fontFamily:"Comic Sans",fontSize:20,fontStyle:"italic",fill:"#000",textShadow:"rgba(0,0,0,0.3) 1px 1px 1px",padding:10},n={left:e,top:a,width:250,height:40,fill:"#fff",backgroundColor:"#fff",rx:10,ry:10,stroke:"#bbb",strokeWidth:1};this._addTempMessage(t,i,n)},_addTempMessage:function(t,e,a){e||(e={}),a||(a={});var i=new fabric.Text(t,e),n=new fabric.Rect(a),r=new fabric.Group([n,i]);this.add(r),canvas.renderAll();var s=this,o=this._timeBetweenCommands-100;r.animate("opacity",1,{duration:o/2,onChange:canvas.renderAll.bind(canvas),onComplete:function(){r.animate("opacity",0,{duration:o/2,onChange:canvas.renderAll.bind(canvas),onComplete:function(){s.remove(r),canvas.renderAll()}})}})}}),Card=fabric.util.createClass(fabric.Group,{SPADES:"♠",HEARTS:"♥",DIAMONDS:"♦",CLUBS:"♣",SUITS:{1:"♠",2:"♥",3:"♦",4:"♣"},AS:1,J:11,Q:12,K:13,RANKS:{1:"AS",11:"J",12:"Q",13:"K"},initialize:function(t){t||(t={});var e=t.suit.toString(),a=t.rank.toString();this.suit=e,this.rank=a;var i="#000";e in this.SUITS&&((2==parseInt(e)||2==parseInt(e))&&(i="#f00"),e=this.SUITS[e]),a in this.RANKS&&(a=this.RANKS[a]);var n="Comic Sans",r=new fabric.Rect({width:80,height:120,rx:10,ry:10,fill:"#fff",stroke:"#bbb",strokeWidth:1}),s=new fabric.Rect({width:50,height:90,rx:10,ry:10,fill:"#ccc"});s.setGradient("fill",{x1:0,y1:0,x2:0,y2:s.height,colorStops:{0:"#ddd",1:"#eee"}});var o=new fabric.Text(e,{fill:i,top:-42,left:-32,fontSize:10,fontWeight:"bold",fontFamily:n}),f=new fabric.Text(e,{fill:i,top:42,left:32,angle:180,fontSize:10,fontWeight:"bold",fontFamily:n}),l=new fabric.Text(a,{fill:i,top:-52,left:-32,fontSize:10,fontWeight:"bold",fontFamily:n}),d=new fabric.Text(a,{fill:i,top:52,left:32,angle:180,fontSize:10,fontWeight:"bold",fontFamily:n});this.callSuper("initialize",[r,s,o,l,f,d],t)}}),Deck=fabric.util.createClass(fabric.Group,{type:"Deck",initialize:function(t){if(t||(t={}),this.callSuper("initialize",[],t),t.text){var e={left:-100,fontFamily:"Comic Sans",fontSize:20,fontStyle:"italic",fill:"#fff",textShadow:"rgba(0,0,0,0.3) 1px 1px 1px",padding:10};this.add(new fabric.Text(t.text,e))}this.cardOffset=t.cardOffset||18;var a=t.cards||[];for(var i in a){var n=a[i];this.addCard(n)}},getNextOffset:function(){return this.size()*this.get("cardOffset")},getCards:function(){return this.getObjects()},getCard:function(t,e){var a=this.getCards();for(var i in a){var n=a[i];if(n.suit==t&&n.rank==e)return n}return null},addCards:function(t){for(var e in t){var a=t[e];this.addCard(new Card({suit:a.suit,rank:a.rank}))}},addCard:function(t){var e=this.size();t.set("left",e*this.get("cardOffset")),t.set("angle",2*e),this.add(t)},removeCard:function(t){return this.remove(t),t},removeAll:function(){for(var t=this.getCards(),e=t.length-1;e>=0;e--)"text"!=t[e].type&&this.removeCard(t[e]);canvas.renderAll()},moveCard:function(t,e){var a=this.group;this.removeCard(t),a.add(t),t.set("top",this.getTop()),t.animate("angle",360,{duration:500}),t.animate("top",e.getTop(),{duration:500,onChange:canvas.renderAll.bind(canvas),onComplete:function(){a.remove(t),e.addCard(t),canvas.renderAll()}})}});